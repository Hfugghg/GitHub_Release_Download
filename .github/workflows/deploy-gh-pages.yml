# å·¥ä½œæµåç§°
name: Build and Deploy to GitHub Pages

# å·¥ä½œæµè§¦å‘å™¨
on:
  # å˜æ›´ 1: åªåœ¨ main åˆ†æ”¯æœ‰ push æ“ä½œæ—¶è§¦å‘
  push:
    branches:
      - main

  # å…è®¸åœ¨ GitHub Actions é¡µé¢æ‰‹åŠ¨è§¦å‘æ­¤å·¥ä½œæµ
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      # æ­¥éª¤ 1: æ£€å‡º gh-pages åˆ†æ”¯åˆ°ä¸´æ—¶ç›®å½•ï¼Œç›®çš„æ˜¯ä¸ºäº†è·å– assets æ–‡ä»¶å¤¹
      - name: Checkout gh-pages branch into a temp directory
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: ./gh-pages-temp # æ£€å‡ºåˆ°å­ç›®å½• gh-pages-temp

      # æ­¥éª¤ 2: æ£€å‡º main åˆ†æ”¯çš„æœ€æ–°ä»£ç ï¼ˆè¿™ä¼šè¦†ç›–å½“å‰å·¥ä½œç›®å½•ï¼‰
      - name: Checkout main branch
        uses: actions/checkout@v4
        with:
          ref: main

      # æ­¥éª¤ 3: åŒæ­¥ main åˆ†æ”¯çš„å†…å®¹åˆ°ä¸´æ—¶ç›®å½•
      # ä½¿ç”¨ rsync å‘½ä»¤ï¼Œå®ƒä¼šç”¨ main åˆ†æ”¯çš„æ–‡ä»¶æ›´æ–° gh-pages-temp ç›®å½•
      # -r: é€’å½’, -u: åªåœ¨æºæ–‡ä»¶è¾ƒæ–°æ—¶æ‰æ›´æ–°, -a: å½’æ¡£æ¨¡å¼
      # --delete: ä¼šåˆ é™¤ä¸´æ—¶ç›®å½•ä¸­æœ‰ï¼Œä½† main åˆ†æ”¯æ²¡æœ‰çš„æ–‡ä»¶ï¼ˆä½†æˆ‘ä»¬æ’é™¤äº† assetsï¼‰
      # --exclude: æ’é™¤ä¸éœ€è¦åŒæ­¥çš„æ–‡ä»¶å¤¹
      - name: Sync main branch content to temp directory
        run: |
          rsync -avru --delete \
          --exclude '.git' \
          --exclude '.github' \
          --exclude 'gh-pages-temp' \
          ./ ./gh-pages-temp/

      # æ­¥éª¤ 4: éƒ¨ç½²åˆå¹¶åçš„ä¸´æ—¶ç›®å½•åˆ° gh-pages åˆ†æ”¯
      - name: Deploy to gh-pages branch ğŸš€
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          # å…³é”®: æŒ‡å®šæˆ‘ä»¬å‡†å¤‡å¥½çš„ã€åŒ…å«æ‰€æœ‰æ­£ç¡®æ–‡ä»¶çš„ç›®å½•
          publish_dir: ./gh-pages-temp
          publish_branch: gh-pages
          # å› ä¸ºæˆ‘ä»¬å·²ç»æ‰‹åŠ¨å‡†å¤‡å¥½äº†æ‰€æœ‰æ–‡ä»¶ï¼Œæ‰€ä»¥ä¸å†éœ€è¦ force_orphan æˆ– keep_files
          commit_message: "Deploy: Update site from main branch"