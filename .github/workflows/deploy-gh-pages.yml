# å·¥ä½œæµåç§°
name: Build and Deploy to GitHub Pages

# å·¥ä½œæµè§¦å‘å™¨
on:
  # 1. å½“ main æˆ– gallery-data åˆ†æ”¯æœ‰ push æ“ä½œæ—¶è§¦å‘
  push:
    branches:
      - main
      - gallery-data
  
  # 2. å…è®¸åœ¨ GitHub Actions é¡µé¢æ‰‹åŠ¨è§¦å‘æ­¤å·¥ä½œæµï¼ˆæ–¹ä¾¿è°ƒè¯•ï¼‰
  workflow_dispatch:

# ä¸ºå·¥ä½œæµè®¾ç½®æƒé™ï¼Œè¿™æ˜¯æ–°ç‰ˆ GitHub Actions çš„æ¨èåšæ³•
permissions:
  contents: write # å…è®¸å·¥ä½œæµä¿®æ”¹ä»“åº“å†…å®¹ï¼ˆä¾‹å¦‚ï¼Œæ¨é€åˆ° gh-pages åˆ†æ”¯ï¼‰
  pages: write    # å…è®¸éƒ¨ç½²åˆ° GitHub Pages
  id-token: write # å…è®¸ä½¿ç”¨ OIDC token è¿›è¡Œèº«ä»½éªŒè¯

# å®šä¹‰ä¸€ä¸ªåä¸º 'build-and-deploy' çš„ä½œä¸š
jobs:
  build-and-deploy:
    # æŒ‡å®šè¿è¡Œæ­¤ä½œä¸šçš„æ“ä½œç³»ç»Ÿç¯å¢ƒ
    runs-on: ubuntu-latest
    
    # ä½œä¸šä¸­çš„æ­¥éª¤
    steps:
      # æ­¥éª¤ 1: æ£€å‡ºï¼ˆCheckoutï¼‰main åˆ†æ”¯çš„ä»£ç 
      # è¿™æ˜¯ä½ çš„ç½‘ç«™æ¡†æ¶ï¼Œå¦‚ HTML, CSS, JS æ–‡ä»¶
      - name: Checkout main branch ğŸ›ï¸
        uses: actions/checkout@v4
        with:
          # æ˜ç¡®æŒ‡å®šæ£€å‡º main åˆ†æ”¯
          ref: main

      # æ­¥éª¤ 2: æ£€å‡ºï¼ˆCheckoutï¼‰gallery-data åˆ†æ”¯çš„å†…å®¹åˆ°ä¸´æ—¶ç›®å½•
      # è¿™é‡Œåªä¸ºäº†è·å– assets æ–‡ä»¶å¤¹
      - name: Checkout gallery-data branch ğŸ–¼ï¸
        uses: actions/checkout@v4
        with:
          # æŒ‡å®šåŒ…å« assets æ–‡ä»¶å¤¹çš„ gallery-data åˆ†æ”¯
          ref: gallery-data
          # å°†æ­¤åˆ†æ”¯çš„å†…å®¹ä¸‹è½½åˆ°ä¸€ä¸ªåä¸º '.gallery-data' çš„ä¸´æ—¶å­ç›®å½•ä¸­
          # è¿™æ ·å¯ä»¥é¿å…ä¸ main åˆ†æ”¯çš„æ–‡ä»¶å†²çª
          path: ./.gallery-data

      # æ­¥éª¤ 3: å‡†å¤‡å’Œåˆå¹¶æ–‡ä»¶
      # å°† main åˆ†æ”¯çš„æ–‡ä»¶å’Œ gallery-data çš„ assets æ–‡ä»¶å¤¹åˆå¹¶
      - name: Combine files âš™ï¸
        run: |
          # åˆ›å»ºä¸€ä¸ªç”¨äºéƒ¨ç½²çš„ç›®å½•ï¼Œåä¸º 'public'
          mkdir public
          
          # å°† main åˆ†æ”¯çš„æ‰€æœ‰å†…å®¹ï¼ˆé™¤äº† .gallery-data ç›®å½•å’Œ .git ç­‰ï¼‰å¤åˆ¶åˆ° public ç›®å½•
          # ä½¿ç”¨ rsync å¯ä»¥æ›´å¥½åœ°æ§åˆ¶æ’é™¤é¡¹
          echo "Copying files from main branch..."
          rsync -av --progress . ./public --exclude ".gallery-data" --exclude ".git" --exclude ".github" --exclude "public"

          # æ£€æŸ¥ .gallery-data/assets æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœå­˜åœ¨ï¼Œåˆ™å¤åˆ¶åˆ° public ç›®å½•
          if [ -d "./.gallery-data/assets" ]; then
            echo "Assets folder found in gallery-data. Copying..."
            cp -r ./.gallery-data/assets ./public/
          else
            echo "Warning: 'assets' folder not found in gallery-data branch. Skipping."
          fi

          # (å¯é€‰) æ‰“å°å‡ºæœ€ç»ˆ public ç›®å½•çš„ç»“æ„ï¼Œæ–¹ä¾¿è°ƒè¯•
          echo "Final directory structure for deployment:"
          ls -R ./public

      # æ­¥éª¤ 4: éƒ¨ç½²åˆ° gh-pages åˆ†æ”¯
      # ä½¿ç”¨ç¤¾åŒºç»´æŠ¤çš„ã€éå¸¸æµè¡Œçš„ action æ¥å®Œæˆéƒ¨ç½²
      - name: Deploy to gh-pages branch ğŸš€
        uses: peaceiris/actions-gh-pages@v4
        with:
          # GitHub Token æ˜¯ç”± GitHub Actions è‡ªåŠ¨æä¾›çš„ï¼Œç”¨äºæˆæƒ
          github_token: ${{ secrets.GITHUB_TOKEN }}
          # æŒ‡å®šè¦éƒ¨ç½²çš„æ–‡ä»¶å¤¹ï¼Œå³æˆ‘ä»¬åˆšåˆšåˆ›å»ºçš„ 'public' ç›®å½•
          publish_dir: ./public
          # æŒ‡å®šç›®æ ‡åˆ†æ”¯
          publish_branch: gh-pages
          # (å¯é€‰) è‡ªå®šä¹‰æäº¤ä¿¡æ¯
          commit_message: "Deploy: ${{ github.event.head_commit.message }}"